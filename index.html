<html>
<body style="margin: 0; padding: 0;">

<video id="myVid" playsinline autoplay style="display: none;"></video>
<canvas id="myCanvas" style="margin:0; padding:0; position: center"></canvas>
<canvas id="offscreenCanvas" style="display: none;"></canvas>

<button id="stop" onclick="exposure = false;">Stop Exposure</button>
<button id="start" onclick="exposure = true;">Start Exposure</button>
<button id="reset" onclick="reset = true;">Reset</button>

<button id="toPNG" onclick="exportPNG()">Export PNG</button>
Leniancy
<input id="leniancy" type="range" min="1" max="100" value="50" onchange="leniancy = document.getElementById('leniancy').value;"></input>


<script>
  document.body.scrollTop = 0; // <-- pull the page to the top
  document.body.style.overflow = 'hidden'; // <-- To hide scrollbar

  const myVid = document.getElementById("myVid");

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 25;

  //Will be offscreen canvas because display: none
  //Used for copying current frames pixels to check against previous frame
  const offscreen = document.getElementById("offscreenCanvas");
  const offCtx = offscreen.getContext("2d");
  offscreen.width = canvas.width;
  offscreen.height = canvas.height;

  var exposure = false;
  var reset = true;

  var data;
  var prevData;
  var leniancy = document.getElementById("leniancy").value;  //leniancy in color

  function exportPNG() {
    var x = window.open();  //open PNG in new tab
    x.document.open();
    x.document.write("<image src=" + canvas.toDataURL() + "></image>");
    x.document.close();
  }

  var flip = 1;


  //ctx.fillRect(0, 0, canvas.width, canvas.height);

  function draw(){
    if(reset){
      exposure = false;
      reset = false;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    if(exposure){

      //flip ^= 1;
      /*
      if(flip){
        ctx.globalCompositeOperation = "soft-light";
      }else{
        ctx.globalCompositeOperation = "hard-light";
      }
      */

      /*
      if(flip){
        ctx.globalCompositeOperation = "difference";
      }else{
        ctx.globalCompositeOperation = "soft-light";
      }
      */
      //Just using differnce looks pretty cool, fairly close to real exposure
      //ctx.globalCompositeOperation = "difference";

      prevData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      offCtx.drawImage(myVid, 0, 0);
      currData = offCtx.getImageData(0, 0, offscreen.width, offscreen.height);

      for(var i = 0; i<currData.data.length; i++){
        if(Math.abs(currData.data[i*4] - prevData.data[i*4]) < leniancy) {  //red
          if(Math.abs(currData.data[i*4 + 1] - prevData.data[i*4 + 1]) < leniancy) {  //green
            if(Math.abs(currData.data[i*4 + 2] - prevData.data[i*4 + 2]) < leniancy) {  //blue
              if(Math.abs(currData.data[i*4 + 3] - prevData.data[i*4 + 3]) < leniancy) {  //alpha
                //do nothing, that pixel is the same as the previous frame
                //console.log("yup")
                continue;
              }
            }
          }
        }

        //Otherwise average previous pixel with new pixel color
        prevData.data[i*4] += (prevData.data[i*4] + currData.data[i*4])/50;
        prevData.data[i*4 + 1] += (prevData.data[i*4 + 1] + currData.data[i*4 + 1])/50;
        prevData.data[i*4 + 2] += (prevData.data[i*4 + 2] + currData.data[i*4 + 2])/50;
        prevData.data[i*4 + 3] += (prevData.data[i*4 + 3] + currData.data[i*4 + 3])/50;
        // prevData.data[i*4] = prevData.data[i*4] ^ currData.data[i*4];
        // prevData.data[i*4 + 1] = prevData.data[i*4 + 1] ^ currData.data[i*4 + 1];
        // prevData.data[i*4 + 2] = prevData.data[i*4 + 2] ^ currData.data[i*4 + 2];
        // prevData.data[i*4 + 3] = prevData.data[i*4 + 3] ^ currData.data[i*4 + 3];
      }

      ctx.putImageData(prevData, 0, 0);

      //ctx.drawImage(myVid, 0, 0);
    }else{
      //ctx.globalCompositeOperation = "source-over";
      //ctx.drawImage(myVid, 0, 0);

    }


    requestAnimationFrame(draw);
  }


  navigator.mediaDevices.getUserMedia({video: true}).then(function(stream){
    var vidTracks = stream.getVideoTracks();
    console.log(vidTracks);
    myVid.srcObject = stream;
    requestAnimationFrame(draw);

  }).catch(function(err){
    console.log(err.name + ": " + err.message);
  });


  window.addEventListener("resize", function(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight-25;
    offscreen.width = canvas.width;
    offscreen.height = canvas.height;
  });
/*
  window.addEventListener("contextmenu", function(e){
    e.preventDefault();   //stops right click bringing up a menu
  });
*/




</script>
</body>
</html>
