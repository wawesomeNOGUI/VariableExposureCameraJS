<html>
<body style="margin: 0; padding: 0;">

<video id="myVid" playsinline autoplay width=0 height=0 style="padding-top:0px; margin:0px;"></video>
<canvas id="myCanvas" style="margin:0; padding:0; position: center"></canvas>
<canvas id="canvas2"></canvas>

<button id="stop" onclick="exposure = false;">Stop Exposure</button>
<button id="start" onclick="exposure = true;">Start Exposure</button>
<button id="reset" onclick="reset = true;">Reset</button>

<button id="toPNG" onclick="exportPNG()">Export PNG</button>

<script>
  document.body.scrollTop = 0; // <-- pull the page to the top
  //document.body.style.overflow = 'hidden'; // <-- To hide scrollbar

  const myVid = document.getElementById("myVid");

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 25;

  //Will be offscreen canvas because we don't offscreen.append to html
  //Used for copying current frames pixels to check against previous frame
  const offscreen = document.createElement('canvas');
  const offCtx = offscreen.getContext("2d");
  offscreen.width = myVid.width;
  offscreen.height = myVid.height;

  var exposure = false;
  var reset = true;

  function exportPNG() {
    var x = window.open();  //open PNG in new tab
    x.document.open();
    x.document.write("<image src=" + canvas.toDataURL() + "></image>");
    x.document.close();
  }

  var flip = 1;
  var data;
  var prevData;

  function draw(){
    if(reset){
      exposure = false;
      reset = false;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    if(exposure){

      flip ^= 1;
      /*
      if(flip){
        ctx.globalCompositeOperation = "soft-light";
      }else{
        ctx.globalCompositeOperation = "hard-light";
      }
      */

      /*
      if(flip){
        ctx.globalCompositeOperation = "difference";
      }else{
        ctx.globalCompositeOperation = "soft-light";
      }
      */
      //Just using differnce looks pretty cool, fairly close to real exposure
      //ctx.globalCompositeOperation = "difference";

      prevData = ctx.getImageData();

      offCtx.drawImage(myVid, 0, 0);
      data = offCtx.getImageData();

      for(var i = 0; i<data.length; i++){
        if(Math.abs(data[i*4] - prevData[i*4]) < 5) {  //red
          if(Math.abs(data[i*4 + 1] - prevData[i*4 + 1]) < 5) {  //green
            if(Math.abs(data[i*4 + 2] - prevData[i*4 + 2]) < 5) {  //blue
              if(Math.abs(data[i*4 + 3] - prevData[i*4 + 3]) < 5) {  //alpha
                //do nothing, that pixel is the same as the previous frame
                continue;
              }
            }
          }
        }

        //Otherwise average previous pixel with new pixel color
        data[i*4] = (prevData[i*4] + data[i*4])/2;
        data[i*4 + 1] = (prevData[i*4 + 1] + data[i*4 + 1])/2;
        data[i*4 + 2] = (prevData[i*4 + 2] + data[i*4 + 2])/2;
        data[i*4 + 3] = (prevData[i*4 + 3] + data[i*4 + 3])/2;
      }

      ctx.drawImage(data, 0, 0);
      //ctx.drawImage(myVid, 0, 0);
    }else{
      //ctx.globalCompositeOperation = "source-over";
    //  ctx.drawImage(myVid, 0, 0);

    }


    requestAnimationFrame(draw);
  }


  navigator.mediaDevices.getUserMedia({video: true}).then(function(stream){
    var vidTracks = stream.getVideoTracks();
    console.log(vidTracks);
    myVid.srcObject = stream;
    requestAnimationFrame(draw);

  }).catch(function(err){
    console.log(err.name + ": " + err.message);
  });


  window.addEventListener("resize", function(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight-25;
  });
/*
  window.addEventListener("contextmenu", function(e){
    e.preventDefault();   //stops right click bringing up a menu
  });
*/




</script>
</body>
</html>
